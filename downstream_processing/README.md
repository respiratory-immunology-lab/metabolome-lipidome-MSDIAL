# Downstream Processing

## Differential abundance testing with limma

The R `limma` package is nicely suited to handling differential abundance (or in this case differential intensity) analysis.
Unlike similar DA packages such as `DESeq2`, `limma` does not require that the data is provided as count data (i.e. integer values).

A number of wrapper functions are provided within this folder that can handle the generation of tables of significantly DA metabolites (along with p-values for all metabolites), produce a `ggplot2` volcano plot, and other functions to plot the individual significant features.

### Continuous explanatory variable

#### Run the limma analysis

The `metab_limma_continuous()` function takes a `SummarizedExperiment` object and a numeric vector `metadata_var` as its primary inputs; the `metadata_var` argument can be either a string value denoting the name of a column in the `SummarizedExperiment` object metadata component, or a numeric vector the same length as the number of samples. The latter options can be useful if you want to manipulate one of the variables, e.g. changing an age input from days to months or years.

##### Arguments

- `metab_SE`: a metabolomics/lipidomics `SummarizedExperiment` object produced by the `pmp_preprocess()` function.
- `metadata_var`: the test variable for limma analysis; can be either a string value that matches a column name in the `metabSE` metadata component, or a numeric vector the same length as the number of samples.
- `model_matrix`: a model matrix generated by the `limma` `model.matrix()` function.
- `rownames`: a vector of feature names with the same length as the number of features (defaults to the `shortname` metadata column if not provided).
- `adj_pval_threshold`: (default: 0.05) the maximum adjusted p-value (q-value) that is considered statistically significant.
- `logFC_threshold`: (default: 1) the minimum log2 fold-change that is considered scientifically meaningful.
- `volc_plot_title`: a custom title for the volcano plot.
- `volc_plot_subtitle`: a custom subtitle for the volcano plot.
- `volc_plot_xlab`: a custom label for the x-axis.
- `volc_plot_ylab`: a custom label for the y-axis.

##### Usage

The minimum inputs for the `metab_limma_continuous()` function are a `SummarizedExperiment` object (e.g. generated through the `pmp_preprocess()` function) and either the name of a numeric metadata column or a numeric explanatory variable. In typical usage, you would not provide a model matrix, as the function will generate one for you. Please provide rownames if you do not have a metadata column named `shortname`. If you want different significance and log2 fold-change thresholds, you can override the default values.

An example with the stool metabolomics dataset:

```r
# Run custom limma function on metabolites vs time
metab_stool_limma_age <- metab_limma_continuous(metab_SE = metab_stool_glog,
                                                metadata_var = metab_stool_glog@metadata$metadata$days / 365) # dividing by 365 to change days into years
                                                adj_pval_threshold = 0.05,
                                                logFC_threshold = 1,
                                                volc_plot_title = 'Differential Intensity Metabolites over Time',
                                                volc_plot_xlab = 'log2FC/year',
                                                volc_plot_ylab = 'Significance\n-log10(adjusted p-value)')

# View the volcano plot
metab_stool_limma_age$volcano_plot

# Save significant values to file
write.csv(metab_stool_limma_age$limma_significant, here::here('output', 'limma', 'stool', 'stool_limma_age_significant.csv'))
```