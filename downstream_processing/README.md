# Downstream Processing

## Differential abundance testing with limma

The R `limma` package is nicely suited to handling differential abundance (or in this case differential intensity) analysis.
Unlike similar DA packages such as `DESeq2`, `limma` does not require that the data is provided as count data (i.e. integer values).

A number of wrapper functions are provided within this folder that can handle the generation of tables of significantly DA metabolites (along with p-values for all metabolites), produce a `ggplot2` volcano plot, and other functions to plot the individual significant features.

### Continuous explanatory variable

#### Run the limma analysis

The `metab_limma_continuous()` function takes a `SummarizedExperiment` object and a numeric vector `metadata_var` as its primary inputs; the `metadata_var` argument can be either a string value denoting the name of a column in the `SummarizedExperiment` object metadata component, or a numeric vector the same length as the number of samples. The latter options can be useful if you want to manipulate one of the variables, e.g. changing an age input from days to months or years.

##### Arguments

- `metab_SE`: a metabolomics/lipidomics `SummarizedExperiment` object produced by the `pmp_preprocess()` function.
- `metadata_var`: the test variable for limma analysis; can be either a string value that matches a column name in the `metabSE` metadata component, or a numeric vector the same length as the number of samples.
- `model_matrix`: a model matrix generated by the `limma` `model.matrix()` function.
- `rownames`: a vector of feature names with the same length as the number of features (defaults to the `shortname` metadata column if not provided).
- `adj_pval_threshold`: (default: 0.05) the maximum adjusted p-value (q-value) that is considered statistically significant.
- `logFC_threshold`: (default: 1) the minimum log2 fold-change that is considered scientifically meaningful.
- `volc_plot_title`: a custom title for the volcano plot.
- `volc_plot_subtitle`: a custom subtitle for the volcano plot.
- `volc_plot_xlab`: a custom label for the x-axis of the volcano plot.
- `volc_plot_ylab`: a custom label for the y-axis of the volcano plot.

##### Usage

The minimum inputs for the `metab_limma_continuous()` function are a `SummarizedExperiment` object (e.g. generated through the `pmp_preprocess()` function) and either the name of a numeric metadata column or a numeric explanatory variable. In typical usage, you would not provide a model matrix, as the function will generate one for you. Please provide rownames if you do not have a metadata column named `shortname`. If you want different significance and log2 fold-change thresholds, you can override the default values.

An example with the stool metabolomics dataset:

```r
# Run custom limma function on metabolites vs time
metab_stool_limma_age <- metab_limma_continuous(metab_SE = metab_stool_glog,
                                                metadata_var = metab_stool_glog@metadata$metadata$days / 365) # dividing by 365 to change days into years
                                                adj_pval_threshold = 0.05,
                                                logFC_threshold = 1,
                                                volc_plot_title = 'Differential Intensity Metabolites over Time',
                                                volc_plot_xlab = 'log2FC/year',
                                                volc_plot_ylab = 'Significance\n-log10(adjusted p-value)')

# View the volcano plot
metab_stool_limma_age$volcano_plot

# Save significant values to file
write.csv(metab_stool_limma_age$limma_significant, here::here('output', 'limma', 'stool', 'stool_limma_age_significant.csv'))
```

<img src="https://github.com/respiratory-immunology-lab/metabolome-lipidome-MSDIAL/downstream_processing/assets/test_volcano.png">

#### Plot the signficant features

The `metab_limma_plot_continuous.R` script contains two functions: `metab_limma_plot_indiv_continuous()` and `metab_limma_plot_all_continuous()`. The second function wraps around the first one to handle the creation of multiple plots, and will probably be the most useful for plotting the top significant features quickly.

##### Arguments

- `metab_limma_cont_object`: an instance of an object output by the `metab_limma_continuous()` function above.
- `feature_num`: (only available in the `metab_limma_plot_indiv_continuous()` function) the row number of the feature in the `limma_significant` data.frame of the `metab_limma_cont_object`.
- `plot_subtitle`: a custom subtitle for the plot.
- `plot_x_label`: a custom label for the x-axis of the plot.
- `plot_y_label`: a custom label for th y-axis of the plot.
- `text_size`: (default: 8) the font size of the plot text.
- `geom_point_fill`: (default: 'black') the colour of the scatter plot dots.
- `geom_point_alpha`: (default: 0.7) the opacity of the scatter plot dots.
- `geom_point_size`: (default: 2) the size of the scatter plot dots.

##### Usage

Only the function for the individual plot requires the row number of the feature you want to plot; this is the row of the `limma_significant` data.frame inside the `metab_limma_cont_object`. The `metab_limma_plot_all_continuous()` function will plot each of the significant features and add them to a list of plots from which you can select either an individual plot or multiple plots to combine together. From this perspective, plotting all significant features saves time, and you are still able to select individual plots later.

For example, with the stool metabolomics dataset, we will create a plot list of all significant features, then select the top 12 (plot list elements 1-12) to combine using `ggarrange()`, and then annotate this using the `ggpubr` function [`annotate_figure()`](https://www.rdocumentation.org/packages/ggpubr/versions/0.4.0/topics/annotate_figure).

```r
# Plot time vs metabolite
metab_stool_limma_age_plots <- metab_limma_plot_all_continuous(metab_limma_cont_object = metab_stool_limma_age, 
                                                               plot_x_label = 'Age (years)')

# Arrange the first 12 most significant into a single plot
metab_stool_limma_age_top12 <- ggarrange(plotlist = metab_stool_limma_age_plots[1:12], nrow = 3, ncol = 4)
metab_stool_limma_age_top12 <- annotate_figure(metab_stool_limma_age_top12, 
                                               top = text_grob('Age-Related Metabolites - Top 12 Differential Intensity Stool Metabolites',
                                                               face = 'bold', size = 12))
```

<img src="https://github.com/respiratory-immunology-lab/metabolome-lipidome-MSDIAL/downstream_processing/assets/test_limma_age_top12.png">

Another thing we can do here is combine this top 12 plot with the volcano plot produced by the `metab_limma_continuous()` function to generate a nice figure. We can do this simply by using `ggarrange()`. You will probably need to reduce the size of your top 12 plot elements (i.e. point size and text size) for this step though; setting `text_size = 5` and `geom_point_size = 1` within your function call to `metab_limma_plot_all_continuous()` should do the trick.

```r
# Arrange the volcano plot with some vertical buffer space
Figure_stool_age_metab.1 <- ggarrange(NULL, metab_stool_limma_age$volcano_plot, NULL, nrow = 3, heights = c(0, 0.6, 0))

# Arrange the volcano plot and the top 12 plot next to each other
Figure_stool_age_metab <- ggarrange(Figure_stool_age_metab.1, metab_stool_limma_age_top12, nrow = 1, widths = c(0.5, 0.5))
```

<img src="https://github.com/respiratory-immunology-lab/metabolome-lipidome-MSDIAL/downstream_processing/assets/test_age_metab.png">